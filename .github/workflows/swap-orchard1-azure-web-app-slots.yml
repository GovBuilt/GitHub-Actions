name: Swap Azure Web App Slots

on:
  workflow_call:
    secrets:
      AZURE_APP_SERVICE_SWAP_SERVICE_PRINCIPAL:
        required: true
      MAINTENANCE_USER_NAME:
        required: false
      MAINTENANCE_PASSWORD:
        required: false
    inputs:
      cancel-workflow-on-failure:
        description: When set to "true", will cancel the current workflow run with all jobs if this workflow fails.
        required: false
        type: string
        default: "false"
      machine-type:
        required: false
        type: string
        default: ubuntu-22.04
        description: The name of the type of machine to run the workflow under.
      timeout-minutes:
        required: false
        type: number
        default: 360
        description: Configuration for the timeout-minutes parameter of the workflow. The 360 is GitHub's default.
      app-name:
        required: true
        type: string
        description: What you see at the top of the blade on the Azure Portal. Can contain uppercase letters too.
      source-slot-name:
        required: false
        type: string
        default: Staging
        description: >
          The slot name of the web app you want to swap the destination slot (of the same web app) with. What you see at
          the top of the blade on the Azure Portal, when you open the slot, before the app name in parenthesis.
      destination-slot-name:
        required: false
        type: string
        default: Production
        description: >
          The slot name of the web app you want to swap with the source slot (of the same web app). What you see at the
          top of the blade on the Azure Portal, when you open the slot, before the app name in parenthesis.
      resource-group-name:
        required: true
        type: string
        description: Name of the resource group.
      application-insights-resource-id:
        required: false
        type: string
        description: >
          ID of the Application Insights resource that the release annotation for the swap should be added to.
          This can e.g. be looked up on the Azure Portal under the given AI resource's Overview page -> JSON View.
      maintenance-host-name:
        required: false
        type: string
        description: TBD
      maintenance-batch-size:
        required: false
        type: string
        default: "0"
        description: TBD

jobs:
  swap-azure-web-app-slots:
    runs-on: ${{ inputs.machine-type }}
    name: Swap Azure Web App Slots
    defaults:
      run:
        shell: pwsh
    timeout-minutes: ${{ inputs.timeout-minutes }}
    steps:
      - name: Login to Azure
        uses: Lombiq/GitHub-Actions/.github/actions/login-to-azure@dev
        env:
          SERVICE_PRINCIPAL: ${{ secrets.AZURE_APP_SERVICE_SWAP_SERVICE_PRINCIPAL }}

      - name: Initialize PowerShell modules
        uses: Lombiq/Infrastructure-Scripts/.github/actions/initialize@dev

      - name: Swap Web App Slots
        run: |
          Switch-AzureWebAppSlots `
            -ResourceGroupName ${{ inputs.resource-group-name }} `
            -WebAppName ${{ inputs.app-name }} `
            -SourceSlotName ${{ inputs.source-slot-name }} `
            -DestinationSlotName ${{ inputs.destination-slot-name }}

      - name: Add Azure Application Insights Release Annotation
        if: ${{ inputs.application-insights-resource-id != '' }}
        uses: Lombiq/GitHub-Actions/.github/actions/add-azure-application-insights-release-annotation@dev
        with:
          application-insights-resource-id: ${{ inputs.application-insights-resource-id }}

      - name: Start AfterSwap Maintenance on the Destination Slot
        if: inputs.maintenance-host-name != ''
        run: |
          $maintenanceParameters = @{
            HostName = '${{ inputs.maintenance-host-name }}'
            UserName = '${{ secrets.MAINTENANCE_USER_NAME }}'
            Password = '${{ secrets.MAINTENANCE_PASSWORD }}'
            BatchSize = '${{ inputs.maintenance-batch-size }}'
            MaintenanceName = '${{ inputs.destination-slot-name }}AfterSwap'
          }
          Start-Maintenance @maintenanceParameters

      - name: Cancel Workflow on Failure
        if: failure() && inputs.cancel-workflow-on-failure == 'true'
        uses: Lombiq/GitHub-Actions/.github/actions/cancel-workflow@dev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
